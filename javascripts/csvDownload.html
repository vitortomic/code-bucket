<script src="FileSaver.js"></script><!-- https://github.com/eligrey/FileSaver.js -->
<script>

    document.addEventListener("DOMContentLoaded", ()=>{
        document.querySelector("#dl").addEventListener("click", async ()=>{
            try {
                //res = await (await fetchCsv()).text()
                res = await fetchCsv()
                const blob = new Blob([res], {type: "text/csv"});
                saveAs(blob, "report.csv");
            }
            catch (e) {
                alert(e)
            }
        })
        const statusPicker = document.querySelector("#statusPicker")
        document.querySelector("#saveToken").addEventListener('click', ()=>{
            let token = document.querySelector("#token").value
            setToken(token)
            populateStatuses(statusPicker)
            setButtonSelectedListener(statusPicker)
        })
    })

    let filter

    let token

    const setToken = (value)=>{
        token = value
    }

    const fetchCsv = ()=>{
        let filterString = filter && filter.option != `ALL` ? `?warrantyClaimStatus=${filter.option}` : ``
        return fetch(`http://localhost:8280/insurance2/v1/insurance2/claims.csv${filterString}`, {
            method: 'GET',
            headers: {
                'Authorization' : `Bearer ${token}`
            }
        })
        .then(res=>{
            if (!res.ok) throw Error(res.statusText)
            return res.text()
        })
    }
    
    const fetchClaimStatuses = ()=>{
        return fetch('http://localhost:8280/insurance2/v1/insurance2/claims/count', {
            method: 'GET',
            headers: {
                'Authorization' : `Bearer ${token}`
            }
        })
        .then(res=>{
            if (!res.ok) throw Error(res.statusText)
            return res.json()
        })
    }

    const populateStatuses = async (statusPicker)=>{
        try {
            let statuses = await fetchClaimStatuses()
            statuses.forEach(status=>{
                let statusButton = document.createElement("button")
                statusButton.id = status.option
                statusButton.innerText = status.name
                statusButton.addEventListener('click', ()=>{
                    filter = status
                    statusPicker.dispatchEvent(new Event('buttonSelected'))
                    statusButton.classList.add('selected')
                })
                statusPicker.appendChild(statusButton)
            })
        }
        catch (e) {
            alert(e)
        }
    }

    const setButtonSelectedListener = (statusPicker)=>{
        statusPicker.addEventListener('buttonSelected', (ev)=>{
            Array.from(ev.target.children).forEach(child=>child.classList.remove('selected'))
        })
    }

</script>
<style>
    .selected {
        transform: scale(1.2, 1.2)
    }
</style>
<input id="token" type="text"></input>
<button id="saveToken">Save token</button>
</br>
</br>
<div id="statusPicker"></div>
</br>
<button id="dl">Download</button>
